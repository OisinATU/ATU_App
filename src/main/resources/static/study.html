<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>ATU App • Study Timer</title>
    <style>
        :root{
            --atu-teal:#005b5e;
            --atu-teal-2:#0c7c80;
            --text:#102027;
            --muted:#6b7280;
            --bg:
                    radial-gradient(1200px 600px at 60% 20%, rgba(12,124,128,.18), transparent 60%),
                    radial-gradient(900px 500px at 30% 70%, rgba(0,91,94,.14), transparent 65%),
                    linear-gradient(180deg, #d7f1ea 0%, #dff3f0 30%, #eaf6f6 60%, #f6f8f9 100%);
            --white: rgba(255,255,255,.92);
        }
        *{box-sizing:border-box}
        body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:var(--bg);min-height:100vh;}

        .topbar{
            background: var(--atu-teal);
            color:#fff;
            height: 86px;
            display:flex;
            align-items:center;
            padding: 0 18px;
            gap: 18px;
            position: sticky;
            top:0;
            z-index:10;
            box-shadow: 0 8px 18px rgba(0,0,0,.18);
        }
        .brand{display:flex;align-items:center;gap:12px;min-width:230px;}
        .brand-badge{width:56px;height:44px;border-radius:10px;background:rgba(255,255,255,.14);display:flex;align-items:center;justify-content:center;font-weight:900;letter-spacing:.5px;}
        .brand-text small{display:block;opacity:.85;font-size:12px;line-height:1.1;}
        .brand-text strong{display:block;font-size:14px;line-height:1.2;margin-top:2px;}
        .nav{display:flex;gap:18px;align-items:center;font-weight:800;flex:1;}
        .nav a{color:#fff;text-decoration:none;opacity:.92;padding:10px 10px;border-radius:999px;}
        .nav a:hover{opacity:1;background:rgba(255,255,255,.10);}
        .nav a.active{background:rgba(255,255,255,.14);}
        .user-chip{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:999px;background:rgba(255,255,255,.12);font-weight:800;white-space:nowrap;}
        .avatar{width:34px;height:34px;border-radius:999px;background:rgba(255,255,255,.25);display:flex;align-items:center;justify-content:center;font-weight:900;}

        .wrap{max-width:980px;margin:0 auto;padding:26px 18px 54px;}
        .card{
            max-width: 620px;
            margin: 22px auto 0;
            padding: 22px;
            border-radius: 24px;
            background: rgba(255,255,255,.14);
            border: 1px solid rgba(255,255,255,.22);
            box-shadow: 0 18px 35px rgba(0,0,0,.10);
            backdrop-filter: blur(10px);
            color: rgba(255,255,255,.95);
        }
        .hint{ text-align:center; font-size:18px; margin: 4px 0 14px; color: var(--white); }

        .subjects{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-bottom:14px;}
        .chip{
            cursor:pointer;
            border: 1px solid rgba(255,255,255,.25);
            background: rgba(255,255,255,.12);
            color: rgba(255,255,255,.95);
            padding: 10px 12px;
            border-radius: 999px;
            font-weight: 900;
            font-size: 13px;
        }
        .chip.active{
            border-color: rgba(255,255,255,.55);
            background: rgba(255,255,255,.18);
            box-shadow: 0 0 0 3px rgba(255,255,255,.10);
        }

        .ringWrap{display:flex;justify-content:center;margin: 10px 0 12px;}
        .ring{width:320px;height:320px;position:relative;}
        .ring svg{width:100%;height:100%;transform:rotate(-90deg);filter:drop-shadow(0 12px 18px rgba(0,0,0,.08));}
        .center{
            position:absolute; inset: 34px;
            border-radius: 999px;
            background: rgba(255,255,255,.26);
            border: 1px solid rgba(255,255,255,.35);
            display:flex;align-items:center;justify-content:center;overflow:hidden;
        }
        .plant{width:160px;height:160px;border-radius:999px;background:rgba(255,255,255,.28);position:relative;}
        .plant:before{content:"";width:78px;height:78px;border-radius:18px 18px 28px 28px;background:rgba(255,255,255,.55);position:absolute;bottom:22px;left:41px;}
        .leaf{width:44px;height:64px;background:rgba(255,255,255,.85);border-radius:44px;position:absolute;top:28px;box-shadow:0 10px 24px rgba(0,0,0,.08);}
        .leaf.l1{transform:rotate(-20deg);left:52px;top:34px;height:60px;}
        .leaf.l2{transform:rotate(18deg);right:52px;top:34px;height:60px;}
        .leaf.l3{left:58px;top:20px;height:70px;opacity:.9;}

        .time{font-size:62px;font-weight:300;letter-spacing:1px;text-align:center;color:rgba(255,255,255,.98);margin: 6px 0 10px;}
        .setupRow{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;align-items:center;margin-bottom:14px;}
        .select,.input{
            padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.26);
            background:rgba(255,255,255,.16);color:rgba(255,255,255,.95);outline:none;font-weight:800;
        }
        .input{width:120px;}
        .btnRow{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;}
        .btn{
            border:none;cursor:pointer;padding:14px 18px;border-radius:14px;font-weight:900;font-size:15px;min-width:128px;
            box-shadow:0 10px 24px rgba(0,0,0,.10);
        }
        .btn.primary{background:#fff;color:#0b2b2d;}
        .btn.ghost{background:rgba(255,255,255,.16);color:rgba(255,255,255,.95);border:1px solid rgba(255,255,255,.22);}
        .btn.danger{background:rgba(225,75,75,.18);color:rgba(255,255,255,.95);border:1px solid rgba(255,255,255,.22);}
        .btn:disabled{opacity:.55;cursor:not-allowed;}
        .note{margin-top:12px;text-align:center;color:rgba(255,255,255,.86);font-size:12px;line-height:1.35;}
        code{color:#e9fffd}
    </style>
</head>

<body>
<header class="topbar">
    <div class="brand">
        <div class="brand-badge">ATU</div>
        <div class="brand-text">
            <small>Atlantic Technological University</small>
            <strong>ATU App</strong>
        </div>
    </div>

    <nav class="nav">
        <a class="active" href="study-timer.html">Study Timer</a>
        <a href="study-dashboard.html">Study Dashboard</a>
        <a href="#">Canteen</a>
        <a href="#">Profile</a>
    </nav>

    <div class="user-chip">
        <span id="username">Oisin Loftus</span>
        <div class="avatar">OL</div>
    </div>
</header>

<main class="wrap">
    <div class="hint">Choose a subject, set a timer, and plant a session.</div>

    <section class="card">
        <div class="subjects" id="subjects"></div>

        <div class="ringWrap">
            <div class="ring">
                <svg viewBox="0 0 120 120" aria-label="Timer progress ring">
                    <circle cx="60" cy="60" r="52" stroke="rgba(255,255,255,.35)" stroke-width="6" fill="transparent"></circle>
                    <circle id="progressCircle" cx="60" cy="60" r="52" stroke="rgba(255,255,255,.92)" stroke-width="6" fill="transparent"
                            stroke-linecap="round" stroke-dasharray="326.73" stroke-dashoffset="326.73"></circle>
                </svg>
                <div class="center" title="Later: customizable image per user">
                    <div class="plant">
                        <div class="leaf l1"></div>
                        <div class="leaf l2"></div>
                        <div class="leaf l3"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="time" id="timeText">25:00</div>

        <div class="setupRow">
            <select class="select" id="preset">
                <option value="25">25 min</option>
                <option value="30">30 min</option>
                <option value="45">45 min</option>
                <option value="60">60 min</option>
            </select>
            <input class="input" id="customMin" type="number" min="1" placeholder="Custom" />
            <button class="btn ghost" id="setBtn" style="min-width:120px;">Set</button>
        </div>

        <div class="btnRow">
            <button class="btn primary" id="startBtn">Plant</button>
            <button class="btn ghost" id="pauseBtn" disabled>Pause</button>
            <button class="btn danger" id="cancelBtn" disabled>Cancel</button>
        </div>

        <div class="note">
            This page logs sessions into localStorage under your selected subject.<br/>
            Dashboard reads from the same storage. Later this becomes API calls.
            (<code>POST /api/study/sessions</code>)
        </div>
    </section>
</main>

<script>
    // ---------- Storage model ----------
    // All sessions live in one array in localStorage:
    // [{id, subjectKey, minutesPlanned, minutesActual, status, startedAt, endedAt}]
    const SESSIONS_KEY = "atu_study_sessions_v1";
    const SUBJECT_KEY = "atu_active_subject_v1";
    const TIMER_MIN_KEY = "atu_timer_minutes_v1";

    const SUBJECTS = [
        { key:"oop", name:"OOP (Java)" },
        { key:"analog", name:"Analog Devices" },
        { key:"internet", name:"Internet Tech 2" },
        { key:"iot", name:"IoT Project" },
        { key:"maths", name:"Maths" },
        { key:"other", name:"Other / Revision" },
    ];

    function loadSessions(){
        const raw = localStorage.getItem(SESSIONS_KEY);
        return raw ? JSON.parse(raw) : [];
    }
    function saveSessions(list){
        localStorage.setItem(SESSIONS_KEY, JSON.stringify(list));
    }
    function uuid(){
        return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
    }

    // ---------- Timer (countdown) ----------
    const CIRC = 2 * Math.PI * 52;
    const circle = document.getElementById("progressCircle");
    circle.setAttribute("stroke-dasharray", CIRC.toFixed(2));
    circle.setAttribute("stroke-dashoffset", CIRC.toFixed(2));

    const timeText = document.getElementById("timeText");
    const preset = document.getElementById("preset");
    const customMin = document.getElementById("customMin");
    const setBtn = document.getElementById("setBtn");

    const startBtn = document.getElementById("startBtn");
    const pauseBtn = document.getElementById("pauseBtn");
    const cancelBtn = document.getElementById("cancelBtn");

    let totalSeconds = 25 * 60;
    let remainingSeconds = totalSeconds;
    let timer = null;
    let running = false;
    let paused = false;

    // session tracking
    let sessionStartMs = null;
    let plannedMinutes = 25;

    function pad(n){ return String(n).padStart(2,"0"); }
    function renderTime(){
        const m = Math.floor(remainingSeconds / 60);
        const s = remainingSeconds % 60;
        timeText.textContent = `${pad(m)}:${pad(s)}`;
    }
    function renderRing(){
        const progress = 1 - (remainingSeconds / totalSeconds);
        const offset = CIRC * (1 - progress);
        circle.setAttribute("stroke-dashoffset", offset.toFixed(2));
    }
    function setTimerMinutes(min){
        plannedMinutes = Math.max(1, Math.floor(min));
        totalSeconds = plannedMinutes * 60;
        remainingSeconds = totalSeconds;
        localStorage.setItem(TIMER_MIN_KEY, String(plannedMinutes));
        renderTime();
        renderRing();
    }

    function setControls(state){
        if (state === "idle"){
            startBtn.disabled = false;
            pauseBtn.disabled = true;
            cancelBtn.disabled = true;
            pauseBtn.textContent = "Pause";
        } else if (state === "running"){
            startBtn.disabled = true;
            pauseBtn.disabled = false;
            cancelBtn.disabled = false;
            pauseBtn.textContent = "Pause";
        } else if (state === "paused"){
            startBtn.disabled = true;
            pauseBtn.disabled = false;
            cancelBtn.disabled = false;
            pauseBtn.textContent = "Resume";
        }
    }

    function tick(){
        if (!running || paused) return;
        remainingSeconds -= 1;

        if (remainingSeconds <= 0){
            remainingSeconds = 0;
            renderTime(); renderRing();
            completeSession();
            return;
        }
        renderTime(); renderRing();
    }

    function start(){
        if (running) return;
        running = true;
        paused = false;
        setControls("running");
        sessionStartMs = Date.now();
        timer = setInterval(tick, 1000);
    }

    function togglePause(){
        if (!running) return;
        paused = !paused;
        setControls(paused ? "paused" : "running");
    }

    function stopTimerInternal(){
        if (timer) clearInterval(timer);
        timer = null;
        running = false;
        paused = false;
        setControls("idle");
        remainingSeconds = totalSeconds;
        renderTime();
        renderRing();
    }

    // ---------- Subject selection ----------
    let activeSubject = localStorage.getItem(SUBJECT_KEY) || SUBJECTS[0].key;

    function renderSubjects(){
        const wrap = document.getElementById("subjects");
        wrap.innerHTML = "";
        for (const s of SUBJECTS){
            const b = document.createElement("button");
            b.className = "chip" + (s.key === activeSubject ? " active" : "");
            b.textContent = s.name;
            b.onclick = () => {
                if (running){
                    alert("Finish or cancel the current timer before switching subject.");
                    return;
                }
                activeSubject = s.key;
                localStorage.setItem(SUBJECT_KEY, activeSubject);
                renderSubjects();
            };
            wrap.appendChild(b);
        }
    }

    // ---------- Logging ----------
    // Rule: completed sessions count toward progress.
    // Cancelled sessions are recorded but don't count toward progress.
    function logSession(status){
        const endedAt = new Date().toISOString();
        const startedAt = sessionStartMs ? new Date(sessionStartMs).toISOString() : endedAt;

        const elapsedSec = sessionStartMs ? Math.max(0, Math.round((Date.now() - sessionStartMs)/1000)) : 0;
        const elapsedMin = Math.max(0, Math.round(elapsedSec / 60));

        const session = {
            id: uuid(),
            subjectKey: activeSubject,
            minutesPlanned: plannedMinutes,
            minutesActual: status === "COMPLETED" ? plannedMinutes : elapsedMin,
            status,
            startedAt,
            endedAt
        };

        const all = loadSessions();
        all.push(session);
        saveSessions(all);
    }

    function completeSession(){
        logSession("COMPLETED");
        stopTimerInternal();
        alert("Session complete ✅ Logged to your subject.");
    }

    function cancelSession(){
        // if they cancel instantly, still logs as cancelled with 0-1 mins depending on rounding
        logSession("CANCELLED");
        stopTimerInternal();
        alert("Session cancelled ⚠️ Logged as cancelled (doesn't count toward progress).");
    }

    // ---------- UI handlers ----------
    setBtn.addEventListener("click", () => {
        if (running) return alert("Stop the current timer before changing duration.");
        const custom = Number(document.getElementById("customMin").value);
        if (custom && custom > 0){
            setTimerMinutes(custom);
            customMin.value = "";
            return;
        }
        setTimerMinutes(Number(preset.value));
    });

    startBtn.addEventListener("click", start);
    pauseBtn.addEventListener("click", togglePause);
    cancelBtn.addEventListener("click", cancelSession);

    // ---------- init ----------
    (function init(){
        renderSubjects();
        const savedMin = Number(localStorage.getItem(TIMER_MIN_KEY));
        if (savedMin && savedMin > 0){
            const options = [...preset.options].map(o => Number(o.value));
            if (options.includes(savedMin)) preset.value = String(savedMin);
            setTimerMinutes(savedMin);
        } else {
            setTimerMinutes(Number(preset.value));
        }
        setControls("idle");
    })();
</script>
</body>
</html>
